image: docker

variables:
  REGISTRY_BASE: registry.gitlab.baixing.cn/fenlei/midway-fe
  MIDWAY_FE: registry.gitlab.baixing.cn/fenlei/midway-fe:${CI_PIPELINE_ID}

stages:
  - release-dev
  - dev-deploy
  - release-test
  - test-deploy
  - release-test1
  - test1-deploy
  - release
  - prod-deploy
  - release-test2
  - test2-deploy
  - test-ci

test-ci-nest-build:
  stage: test-ci
  only: [feat-speed-up-ci@fenlei/midway-fe]
  tags: [k8s-dev-build]
  cache:
    key: 
      files: 
        - package.json
    paths: 
      - node_modules/
  before_script:
    - npm set registry https://registry.npm.taobao.org
    - npm set progress=false
  script:
    - npm ci --cache .npm --silence
    - npm run release:dev
  artifacts:
    name: "nest-build"
    expire_in: 24 hrs
    paths:
      - dist/

test-ci-mvip-build:
  stage: test-ci
  only: [feat-speed-up-ci@fenlei/midway-fe]
  tags: [k8s-dev-build]
  cache:
    key: 
      files: 
        - app/mvip-manager/package.json
    paths: 
      - app/mvip-manager/node_modules/
  before_script:
    - npm set registry https://registry.npm.taobao.org
    - npm set progress=false
  script:
    - cd app/mvip-manager/
    - npm ci --cache .npm --silence
    - npm run release:dev
  artifacts:
    name: "mvip-build"
    expire_in: 24 hrs
    paths:
      - app/mvip-manager/dist/

test-ci-release:
  stage: test-ci
  only: [feat-speed-up-ci@fenlei/midway-fe]
  when: on_success
  tags: [k8s-dev-build]
  script:
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN registry.gitlab.baixing.cn
    - docker build --pull -t $MIDWAY_FE -f ./dev.Dockerfile .
    - docker push $MIDWAY_FE

release-dev:
  stage: release-dev
  only:
    - dev@fenlei/midway-fe
  tags:
    - k8s-dev-build
  script:
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN registry.gitlab.baixing.cn
    - docker build --pull -t $MIDWAY_FE -f ./dev.Dockerfile .
    - docker push $MIDWAY_FE

dev-deploy:
  stage: dev-deploy
  when: manual
  only:
    - dev@fenlei/midway-fe
  tags:
    - aliyun-k8s-dev
  script:
    - kubectl set image -n cat deployments --selector app=midway-fe *=$MIDWAY_FE

release-test:
  stage: release-test
  only:
    - test@fenlei/midway-fe
  tags:
    - k8s-dev-build
  script:
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN registry.gitlab.baixing.cn
    - docker build --pull -t $MIDWAY_FE -f ./test.Dockerfile .
    - docker push $MIDWAY_FE

test-deploy:
  stage: test-deploy
  only:
    - test@fenlei/midway-fe
  tags:
    - aliyun-k8s-dev
  script:
    - kubectl set image -n test-cat deployments --selector app=midway-fe *=$MIDWAY_FE

release-test1:
  stage: release-test1
  only:
  - test1@fenlei/midway-fe
  tags:
  - k8s-dev-build
  script:
  - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN registry.gitlab.baixing.cn
  - docker build --pull -t $MIDWAY_FE -f ./test1.Dockerfile .
  - docker push $MIDWAY_FE

test1-deploy:
  stage: test1-deploy
  only:
  - test1@fenlei/midway-fe
  tags:
  - aliyun-k8s-dev
  script:
  - kubectl set image -n bxapplets deployments --selector app=midway-fe *=$MIDWAY_FE

release-test2:
  stage: release-test2
  only:
  - test2@fenlei/midway-fe
  tags:
  - k8s-dev-build
  script:
  - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN registry.gitlab.baixing.cn
  - docker build --pull -t $MIDWAY_FE -f ./test2.Dockerfile .
  - docker push $MIDWAY_FE

test2-deploy:
  stage: test2-deploy
  only:
  - test2@fenlei/midway-fe
  tags:
  - aliyun-k8s-dev
  script:
  - kubectl set image -n test-bxapplets deployments --selector app=midway-fe *=$MIDWAY_FE


release:
  stage: release
  only:
    - master@fenlei/midway-fe
#  tags:
#    - k8s-dev-build
  script:
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN registry.gitlab.baixing.cn
    - docker build --pull -t $MIDWAY_FE .
    - docker push $MIDWAY_FE
    - docker rmi $MIDWAY_FE

deploy:
  stage: prod-deploy
  when: manual
  only:
    - master@fenlei/midway-fe
  tags:
    - aliyun-prod-deploy
  script:
    - kubectl set image -n cat deployments --selector app=midway-fe *=$MIDWAY_FE
